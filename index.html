<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fluxon — Calculadora de Circuitos (SPA)</title>

  <!-- Favicon (ícone da aba do navegador) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2210%22 fill=%22%23FBBF24%22/><text x=%2250%22 y=%2250%22 font-size=%2260%22 font-weight=%22bold%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%231A2E2E%22>F</text></svg>">

  <!-- Tailwind CDN (rápido para protótipo). Em produção use build do Tailwind. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase UMD bundle -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <style>
    .hide-scrollbar::-webkit-scrollbar { display:none; } 
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .led { width:12px; height:12px; border-radius:9999px; box-shadow:0 0 6px rgba(0,0,0,0.12); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="index.html" class="flex items-center gap-3">
          <div class="w-10 h-10 rounded bg-amber-400 flex items-center justify-center font-bold text-teal-800">F</div>
          <div>
            <div class="font-bold text-lg">Fluxon.Click</div>
            <div class="text-xs text-gray-500">Plataforma para Eletricistas</div>
          </div>
        </a>
      </div>

      <!-- Menu de Navegação -->
      <nav class="hidden lg:flex items-center gap-6">
        <a href="index.html" class="text-sm font-semibold text-teal-600 border-b-2 border-teal-600 pb-1">Calculadora</a>
        <a href="clientes.html" class="text-sm font-medium text-gray-500 hover:text-teal-600 transition-colors">Clientes</a>
        <a href="orcamentos.html" class="text-sm font-medium text-gray-500 hover:text-teal-600 transition-colors">Orçamentos</a>
        <a href="dashboard.html" class="text-sm font-medium text-gray-500 hover:text-teal-600 transition-colors">Dashboard</a>
      </nav>

      <div class="flex items-center gap-4 min-w-[150px] justify-end">
        <!-- Status icon -->
        <div id="status-text" class="text-sm text-gray-600 hidden sm:block">Deslogado</div>

        <!-- user/email & logout -->
        <div id="user-info" class="hidden items-center gap-3">
          <button id="btn-logout" class="bg-amber-500 hover:bg-amber-600 text-gray-900 px-3 py-2 rounded">Sair</button>
        </div>

        <div id="auth-cta" class="text-sm text-gray-600">Faça login para usar a calculadora</div>
      </div>
    </div>
  </header>
  <div class="bg-white border-t lg:hidden">
    <nav class="max-w-6xl mx-auto px-4 py-2 flex items-center justify-center gap-6 text-sm">
        <a href="index.html" class="font-semibold text-teal-600">Calculadora</a>
        <a href="clientes.html" class="font-medium text-gray-500 hover:text-teal-600">Clientes</a>
        <a href="orcamentos.html" class="font-medium text-gray-500 hover:text-teal-600">Orçamentos</a>
        <a href="dashboard.html" class="font-medium text-gray-500 hover:text-teal-600">Dashboard</a>
    </nav>
  </div>

  <main class="max-w-6xl mx-auto p-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">

      <!-- Auth panel -->
      <aside class="col-span-1 bg-white p-6 rounded-lg shadow">
        <h3 class="font-extrabold text-xl mb-3">Conta</h3>

        <div id="msg" class="mb-4 hidden p-3 rounded text-sm"></div>

        <!-- Form de login/signup -->
        <form id="auth-form" class="space-y-4">
          <div>
            <label class="text-sm block mb-1">E-mail</label>
            <input id="input-email" type="email" required class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="text-sm block mb-1">Senha</label>
            <input id="input-password" type="password" required class="w-full border rounded px-3 py-2" />
          </div>

          <div class="flex gap-2">
            <button id="btn-login" type="button" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded">Entrar</button>
            <button id="btn-signup" type="button" class="px-3 py-2 border rounded">Criar Conta</button>
          </div>

          
        </form>
<br>
        <!-- Painel quando está logado -->
        <div id="account-panel" class="hidden space-y-2">
          <div class="text-sm">Você está logado como:</div>
          <div id="account-email" class="font-bold"></div>
          <div id="account-uid" class="text-xs text-gray-500"></div>
          <div class="pt-4 space-y-2">
            <button id="btn-logout-2" class="w-full bg-amber-100 text-amber-800 px-3 py-2 rounded hover:bg-amber-200">Sair da Conta</button>
          </div>
        </div>
      </aside>

      <!-- App / Calculadora -->
      <section class="col-span-2 bg-white p-6 rounded-lg shadow">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-extrabold text-2xl">Calculadora de Dimensionamento de Condutor</h2>
          <div class="text-sm text-gray-500">Use com responsabilidade — verifique NBR antes de aplicar.</div>
        </div>
        
        <div id="locked" class="p-6 border-2 border-dashed border-gray-200 rounded text-center text-gray-600 bg-gray-50">
          <h3 class="font-extrabold text-xl mb-3 text-gray-800">Bem-vindo à Calculadora de Dimensionamento de Condutor Fluxon!</h3>
          <p class="mb-4 text-gray-700">
            Esta ferramenta foi desenvolvida para auxiliar no dimensionamento de condutores elétricos e disjuntores,
            considerando os principais critérios da NBR 5410, como capacidade de corrente, queda de tensão e seções mínimas normativas.
          </p>
          <p class="mb-4 text-amber-700 font-semibold">
            <strong class="text-red-600">Atenção:</strong> Os resultados fornecidos são para cunho exclusivamente informativo e educacional.
            É imprescindível que todos os cálculos sejam revisados e validados por um profissional eletricista qualificado
            e que as instalações sigam rigorosamente as normas técnicas vigentes antes de qualquer aplicação prática.
          </p>
          <p class="mb-6 text-gray-700">
            Ao utilizar a calculadora, você poderá estimar a seção do cabo e o disjuntor mais adequados para o seu projeto,
            otimizando a segurança e a eficiência da instalação elétrica.
          </p>
          <p class="text-lg font-bold text-teal-600">
            Faça login ou crie uma conta para começar a usar a calculadora agora mesmo!
          </p>
        </div>

        <div id="app" class="hidden space-y-6">

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="text-sm">Sistema</label>
              <select id="sel-system" class="w-full border rounded px-2 py-2">
                <option value="single">Monofásico (F+N)</option>
                <option value="biphasic">Bifásico (F+F)</option>
                <option value="three">Trifásico (3φ)</option>
              </select>
            </div>

            <div>
              <label class="text-sm">Tensão (V)</label>
              <input id="input-voltage" type="number" value="220" class="w-full border rounded px-2 py-2" />
            </div>

            <div>
              <label class="text-sm">Material</label>
              <select id="sel-material" class="w-full border rounded px-2 py-2">
                <option value="copper">Cobre</option>
                <option value="aluminum">Alumínio</option>
              </select>
            </div>
          </div>

          <div>
            <label class="text-sm">Tipo de Circuito</label>
            <select id="sel-circuit-type" class="w-full border rounded px-2 py-2">
              <option value="power" selected>Tomadas (TUG/TUE)</option>
              <option value="lighting">Iluminação</option>
            </select>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm">Potência Total (W)</label>
              <input id="input-power" type="number" value="1000" class="w-full border rounded px-3 py-2" />
            </div>
            <div>
              <label class="text-sm">Comprimento (m) — ida</label>
              <input id="input-length" type="number" value="30" class="w-full border rounded px-3 py-2" />
            </div>
          </div>

          <div>
            <label class="text-sm">Método de Instalação (NBR 5410)</label>
            <select id="sel-method" class="w-full border rounded px-2 py-2">
              <option value="B1" selected>B1: Eletroduto em alvenaria</option>
              <option value="B2">B2: Eletroduto aparente</option>
              <option value="A1">A1: Cabo unipolar em eletroduto</option>
              <option value="A2">A2: Cabo multipolar em eletroduto</option>
              <option value="C">C: Cabo multipolar sobre parede</option>
              <option value="D">D: Eletroduto enterrado</option>
            </select>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="text-sm">Fator de Potência (cos φ)</label>
              <input id="input-pf" type="number" value="0.92" step="0.01" min="0" max="1" class="w-full border rounded px-3 py-2" />
            </div>
            <div>
              <label class="text-sm">Fator de Temp. (FCT)</label>
              <select id="input-fct" class="w-full border rounded px-2 py-2">
                <option value="1.22">10 °C</option>
                <option value="1.17">15 °C</option>
                <option value="1.12">20 °C</option>
                <option value="1.06">25 °C</option>
                <option value="1.00" selected>30 °C (Padrão)</option>
                <option value="0.94">35 °C</option>
                <option value="0.87">40 °C</option>
                <option value="0.79">45 °C</option>
                <option value="0.71">50 °C</option>
                <option value="0.61">55 °C</option>
              </select>
            </div>
            <div>
              <label class="text-sm">Fator de Agrup. (FCA)</label>
              <select id="input-fca" class="w-full border rounded px-2 py-2">
                <option value="1.00" selected>1 Circuito (Padrão)</option>
                <option value="0.80">2 Circuitos</option>
                <option value="0.70">3 Circuitos</option>
                <option value="0.65">4 Circuitos</option>
                <option value="0.60">5 Circuitos</option>
                <option value="0.57">6 Circuitos</option>
                <option value="0.52">7 ou 8 Circuitos</option>
                <option value="0.50">9 ou mais Circuitos</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
            <div>
              <label class="text-sm">Queda de Tensão Permitida (%)</label>
              <input id="input-vd" type="number" value="3" class="w-full border rounded px-3 py-2" />
            </div>

            <div class="lg:col-span-2">
              <button id="btn-calc" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded w-full">Calcular & Salvar</button>
            </div>

            <div>
              <button id="btn-reset" class="border px-4 py-2 rounded w-full">Resetar</button>
            </div>
          </div>

          <!-- Resultado -->
          <div class="bg-gray-50 border p-4 rounded">
            <div id="result-area" class="text-gray-500">Resultados aparecerão aqui após clicar em "Calcular & Salvar".</div>
            
          </div>

          <!-- Histórico -->
          <div>
            <h3 class="font-bold mb-2">Histórico de Cálculos</h3>
            <div id="history" class="space-y-3 max-h-56 overflow-auto hide-scrollbar p-2"></div>
            <div id="history-empty" class="text-sm text-gray-500 mt-2">Nenhum cálculo salvo ainda.</div>
          </div>

        </div>

      </section>
    </div>

  </main>

  <!-- Seção Ilustrativa de Futuras Funcionalidades -->
  <section id="features-section" class="max-w-6xl mx-auto p-6 mt-8">
    <div class="text-center mb-12">
      <h2 class="text-3xl font-extrabold text-gray-800 mb-2">Gerencie Seus Projetos de Ponta a Ponta</h2>
      <p class="text-gray-600">Nossa plataforma oferece um ecossistema completo para eletricistas, da calculadora ao cliente.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- Ilustração: Gestão de Clientes -->
      <a href="clientes.html" class="block bg-white p-6 rounded-lg shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
        <div class="flex flex-col h-full">
          <h3 class="font-bold text-xl mb-4 text-teal-700">Gestão de Clientes</h3>
          <p class="text-sm text-gray-600 mb-6 flex-grow">Organize todos os seus clientes em um só lugar, com acesso rápido a projetos e informações de contato.</p>
          <div class="space-y-3 mt-auto">
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border">
              <div class="w-10 h-10 rounded-full bg-teal-100 text-teal-700 flex items-center justify-center font-bold">A</div>
              <div>
                <div class="font-semibold">Ana Costa</div>
                <div class="text-xs text-gray-500">ana.costa@email.com</div>
              </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border">
              <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center font-bold">B</div>
              <div>
                <div class="font-semibold">Bruno Martins</div>
                <div class="text-xs text-gray-500">bruno.m@email.com</div>
              </div>
            </div>
          </div>
        </div>
      </a>

      <!-- Ilustração: Controle de Orçamentos -->
      <a href="orcamentos.html" class="block bg-white p-6 rounded-lg shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
        <div class="flex flex-col h-full">
          <h3 class="font-bold text-xl mb-4 text-teal-700">Controle de Orçamentos</h3>
          <p class="text-sm text-gray-600 mb-6 flex-grow">Crie, envie e acompanhe o status dos seus orçamentos de forma profissional e centralizada.</p>
          <div class="space-y-3 mt-auto">
            <div class="p-3 border rounded-lg">
              <div class="flex justify-between items-center">
                <span class="font-semibold">#ORC-0125</span>
                <span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-1 rounded-full">Aprovado</span>
              </div>
              <div class="text-sm text-gray-500 mt-1">Residência J. Silva - R$ 4.500,00</div>
            </div>
            <div class="p-3 border rounded-lg">
              <div class="flex justify-between items-center">
                <span class="font-semibold">#ORC-0126</span>
                <span class="text-xs font-medium bg-amber-100 text-amber-800 px-2 py-1 rounded-full">Pendente</span>
              </div>
              <div class="text-sm text-gray-500 mt-1">Loja Centro - R$ 12.800,00</div>
            </div>
          </div>
        </div>
      </a>

      <!-- Ilustração: Dashboard -->
      <a href="dashboard.html" class="block bg-white p-6 rounded-lg shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all">
        <div class="flex flex-col h-full">
          <h3 class="font-bold text-xl mb-4 text-teal-700">Dashboard Inteligente</h3>
          <p class="text-sm text-gray-600 mb-6 flex-grow">Visualize métricas importantes do seu negócio, como faturamento e projetos em andamento, em um painel claro e objetivo.</p>
          <div class="bg-gray-50 p-4 rounded-lg border mt-auto space-y-4">
            <div class="grid grid-cols-2 gap-4 text-center">
              <div>
                <div class="text-xs text-gray-500">Faturamento (Mês)</div>
                <div class="font-bold text-lg text-green-600">R$ 4.850</div>
              </div>
              <div>
                <div class="text-xs text-gray-500">Total Clientes</div>
                <div class="font-bold text-lg text-teal-700">12</div>
              </div>
            </div>
          </div>
        </div>
      </a>

    </div>
  </section>

  <!-- Nova Seção de Vendas -->
  <section id="sales-section" class="bg-white py-16 lg:py-24">
    <div class="max-w-5xl mx-auto px-6">

      <div class="text-center mb-16">
        <h2 class="text-3xl lg:text-4xl font-extrabold text-gray-900">Uma Plataforma Completa para o Eletricista Moderno</h2>
        <p class="mt-4 text-lg text-gray-600">Deixe as planilhas e anotações para trás. Centralize, agilize e profissionalize seu trabalho diário.</p>
      </div>

      <div class="space-y-16">

        <!-- Feature 1: Calculadora -->
        <div class="grid md:grid-cols-2 gap-8 lg:gap-12 items-center">
          <div class="text-center md:text-left">
            <div class="inline-flex items-center justify-center p-3 bg-teal-100 text-teal-700 rounded-lg mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 21a9 9 0 110-18 9 9 0 010 18z" /></svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Calcule com Confiança e Precisão</h3>
            <p class="mt-3 text-gray-600">Nossa calculadora de dimensionamento segue os critérios da NBR 5410 para garantir a segurança e a eficiência das suas instalações. Evite desperdício de material e dimensione cabos e disjuntores corretamente em segundos.</p>
          </div>
          <div class="bg-gray-100 p-6 rounded-lg border">
            <div class="font-mono text-sm space-y-2">
              <p><span class="text-teal-600 font-bold">&gt;</span> Corrente de Projeto (Ib): <span class="font-bold">18.9 A</span></p>
              <p><span class="text-teal-600 font-bold">&gt;</span> Cabo Sugerido: <span class="font-bold text-xl">4.0 mm²</span></p>
              <p><span class="text-teal-600 font-bold">&gt;</span> Disjuntor (In): <span class="font-bold text-xl">20 A</span></p>
              <p class="text-green-600 font-bold pt-2 border-t mt-2">&gt; Coordenação OK: Ib &lt; In &lt; Iz</p>
            </div>
          </div>
        </div>

        <!-- Feature 2: Orçamentos -->
        <div class="grid md:grid-cols-2 gap-8 lg:gap-12 items-center">
          <div class="order-2 md:order-1 text-center md:text-left">
            <div class="inline-flex items-center justify-center p-3 bg-amber-100 text-amber-700 rounded-lg mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Crie Orçamentos Profissionais em Minutos</h3>
            <p class="mt-3 text-gray-600">Utilize nosso construtor de orçamentos para selecionar serviços de tabelas pré-cadastradas e gerar uma proposta detalhada e convincente para seu cliente. Acompanhe o status de cada orçamento e nunca mais perca uma oportunidade.</p>
          </div>
          <div class="order-1 md:order-2 bg-gray-100 p-6 rounded-lg border">
            <div class="space-y-3">
              <div class="p-3 border rounded-lg bg-white shadow-sm">
                <div class="flex justify-between items-center"><span class="font-semibold">#ORC-0125</span><span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-1 rounded-full">Aprovado</span></div>
                <div class="text-sm text-gray-500 mt-1">Residência J. Silva - R$ 4.500,00</div>
              </div>
              <div class="p-3 border rounded-lg bg-white shadow-sm">
                <div class="flex justify-between items-center"><span class="font-semibold">#ORC-0126</span><span class="text-xs font-medium bg-amber-100 text-amber-800 px-2 py-1 rounded-full">Pendente</span></div>
                <div class="text-sm text-gray-500 mt-1">Loja Centro - R$ 12.800,00</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Feature 3: Dashboard -->
        <div class="grid md:grid-cols-2 gap-8 lg:gap-12 items-center">
          <div class="text-center md:text-left">
            <div class="inline-flex items-center justify-center p-3 bg-indigo-100 text-indigo-700 rounded-lg mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800">Tenha uma Visão Clara do seu Negócio</h3>
            <p class="mt-3 text-gray-600">O dashboard centraliza suas métricas mais importantes. Acompanhe seu faturamento mensal, o número de clientes e os projetos aprovados. Tome decisões baseadas em dados e veja seu negócio crescer de forma organizada.</p>
          </div>
          <div class="bg-gray-100 p-6 rounded-lg border grid grid-cols-2 gap-6">
            <div class="bg-white p-4 rounded-lg text-center shadow-sm"><div class="text-sm text-gray-500">Faturamento</div><div class="text-2xl font-bold text-green-600">R$ 7.280</div></div>
            <div class="bg-white p-4 rounded-lg text-center shadow-sm"><div class="text-sm text-gray-500">Clientes</div><div class="text-2xl font-bold text-teal-700">23</div></div>
            <div class="bg-white p-4 rounded-lg text-center shadow-sm"><div class="text-sm text-gray-500">Pendentes</div><div class="text-2xl font-bold text-amber-600">4</div></div>
            <div class="bg-white p-4 rounded-lg text-center shadow-sm"><div class="text-sm text-gray-500">Aprovados</div><div class="text-2xl font-bold text-indigo-600">9</div></div>
          </div>
        </div>

      </div>

      <!-- Final CTA -->
      <div class="text-center mt-24">
        <h3 class="text-2xl lg:text-3xl font-extrabold text-gray-900">Pronto para otimizar seu trabalho?</h3>
        <p class="mt-3 text-lg text-gray-600">Crie sua conta gratuita e tenha acesso a todas as ferramentas agora mesmo.</p>
        <a href="#auth-form" class="mt-8 inline-block bg-teal-600 text-white font-bold text-lg px-8 py-4 rounded-lg hover:bg-teal-700 transition-colors">
          Começar Agora
        </a>
      </div>

    </div>
  </section>

<script>
/*
  CONFIGURE AQUI:
  Substitua as strings abaixo pelas suas credenciais do Supabase.
*/
const SUPABASE_URL = 'https://mnehllsfvhmdqxdxyqle.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uZWhsbHNmdmhtZHF4ZHh5cWxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MzM3NTksImV4cCI6MjA3MjQwOTc1OX0.DVxpiIVVHqiSKZfZYJ8mXsoy3gMaOxI3O4N4fa5G-Xc';

/*
  Cria client Supabase. O UMD fornece window.supabase e/ou window.supabaseJs dependendo da versão.
  Fazemos uma detecção para manter compatibilidade.
*/
const createClient = (window.supabase && window.supabase.createClient)
  ? window.supabase.createClient
  : (window.supabaseJs && window.supabaseJs.createClient)
    ? window.supabaseJs.createClient
    : null;

if (!createClient) {
  console.error('Supabase UMD não encontrado. Verifique o CDN import.');
  alert('Erro: Supabase não carregado. Veja o console.');
}

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* --- DOM references --- */
const el = {
  statusLed: document.getElementById('status-led'),
  statusText: document.getElementById('status-text'),
  userInfo: document.getElementById('user-info'),
  authCta: document.getElementById('auth-cta'),
  msg: document.getElementById('msg'),
  authForm: document.getElementById('auth-form'),
  inputEmail: document.getElementById('input-email'),
  inputPassword: document.getElementById('input-password'),
  btnLogin: document.getElementById('btn-login'),
  btnSignup: document.getElementById('btn-signup'),
  btnLogout: document.getElementById('btn-logout'),
  btnLogout2: document.getElementById('btn-logout-2'),
  accountPanel: document.getElementById('account-panel'),
  accountEmail: document.getElementById('account-email'),
  accountUid: document.getElementById('account-uid'),

  locked: document.getElementById('locked'),
  app: document.getElementById('app'),
  selSystem: document.getElementById('sel-system'),
  inputVoltage: document.getElementById('input-voltage'),
  selMaterial: document.getElementById('sel-material'),
  selCircuitType: document.getElementById('sel-circuit-type'),
  selMethod: document.getElementById('sel-method'),
  inputPower: document.getElementById('input-power'),
  inputLength: document.getElementById('input-length'),
  inputVd: document.getElementById('input-vd'),
  inputPf: document.getElementById('input-pf'),
  inputFct: document.getElementById('input-fct'),
  inputFca: document.getElementById('input-fca'),
  btnCalc: document.getElementById('btn-calc'),
  btnReset: document.getElementById('btn-reset'),
  resultArea: document.getElementById('result-area'),
  saveNote: document.getElementById('save-note'),
  history: document.getElementById('history'),
  historyEmpty: document.getElementById('history-empty'),
};
const featuresSection = document.getElementById('features-section');
const salesSection = document.getElementById('sales-section');

/* --- Helpers --- */
function showMsg(text, type='info') {
  const elMsg = el.msg;
  elMsg.className = 'mb-4 p-3 rounded text-sm';
  if (type === 'error') elMsg.classList.add('bg-red-100','text-red-700');
  else if (type === 'success') elMsg.classList.add('bg-green-50','text-teal-900');
  else elMsg.classList.add('bg-gray-100','text-gray-800');
  elMsg.textContent = text;
  elMsg.classList.remove('hidden');
  setTimeout(()=> elMsg.classList.add('hidden'), 6000);
}

/* --- Estado local --- */
let currentUser = null;

/* --- Atualiza UI com base no usuário (sessão) --- */
function setLoggedState(user) {
  currentUser = user;
  if (user) {
    // logged UI
    el.locked.classList.add('hidden');
    el.app.classList.remove('hidden');
    el.userInfo.classList.remove('hidden');
    el.authCta.classList.add('hidden');
    el.accountPanel.classList.remove('hidden');
    el.accountEmail.textContent = user.email;
    el.accountUid.textContent = 'UID: ' + user.id;
    el.statusText.textContent = user.email.split('@')[0];
    el.statusText.title = user.email;
    el.saveNote.textContent = 'Cálculos serão salvos na tabela `calculations` do Supabase.';
    loadHistory();
    featuresSection.classList.add('hidden');
    salesSection.classList.add('hidden');
  } else {
    // logged out UI
    el.locked.classList.remove('hidden');
    el.app.classList.add('hidden');
    el.userInfo.classList.add('hidden');
    el.authCta.classList.remove('hidden');
    el.accountPanel.classList.add('hidden');
    el.accountUid.textContent = '';
    el.statusText.title = '';
    el.statusText.textContent = 'Deslogado';
    el.saveNote.textContent = '';
    el.resultArea.innerHTML = 'Resultados aparecerão aqui após clicar em "Calcular & Salvar".';
    el.history.innerHTML = '';
    el.historyEmpty.classList.remove('hidden');
    featuresSection.classList.remove('hidden');
    salesSection.classList.remove('hidden');
  }
}

/* --- Auth: signup / login / logout --- */
async function signUp() {
  const email = el.inputEmail.value.trim();
  const password = el.inputPassword.value;
  if (!email || !password) return showMsg('Preencha e-mail e senha.', 'error');
  try {
    const { error } = await supabase.auth.signUp({ email, password });
    if (error) throw error;
    showMsg('Conta criada! Verifique sua caixa de entrada para confirmar o e-mail.', 'success');
  } catch (err) {
    showMsg(err.message || String(err), 'error');
  }
}

async function signIn() {
  const email = el.inputEmail.value.trim();
  const password = el.inputPassword.value;
  if (!email || !password) return showMsg('Preencha e-mail e senha.', 'error');
  try {
    const { error, data } = await supabase.auth.signInWithPassword({ email, password });
    if (error) throw error;
    currentUser = data.user;
    setLoggedState(currentUser);
    showMsg('Logado com sucesso.', 'success');
  } catch (err) {
    showMsg(err.message || String(err), 'error');
  }
}

async function signOut() {
  await supabase.auth.signOut();
  currentUser = null;
  setLoggedState(null);
  showMsg('Você saiu.', 'info');
}

/* --- Escuta mudanças de autenticação (ex.: login em outra aba) --- */
supabase.auth.onAuthStateChange((event, session) => {
  setLoggedState(session?.user ?? null);
});

/* --- Calculadora (mesma lógica explicada) --- */
function computeResult() {
  const V = Number(el.inputVoltage.value);
  const L = Number(el.inputLength.value);
  const vdP = Number(el.inputVd.value);
  const pf = Number(el.inputPf.value);
  const FCT = Number(el.inputFct.value);
  const FCA = Number(el.inputFca.value);
  const method = el.selMethod.value;

  if (!V || V <= 0) return { error: 'Tensão inválida' };
  if (!L || L <= 0) return { error: 'Comprimento inválido' };
  if (vdP <= 0) return { error: '% de queda de tensão inválido' };
  if (!pf || pf <= 0 || pf > 1) return { error: 'Fator de potência inválido (use 0 a 1)' };
  if (!FCT || FCT <= 0) return { error: 'Fator de Temperatura (FCT) inválido' };
  if (!FCA || FCA <= 0) return { error: 'Fator de Agrupamento (FCA) inválido' };

  let Ib = 0; // Corrente de Projeto
  const P = Number(el.inputPower.value);
  if (!P || P <= 0) return { error: 'Potência inválida' };
  
  const systemType = el.selSystem.value;
  if (systemType === 'three') {
    Ib = P / (Math.sqrt(3) * V * pf);
  } else { // Monofásico e Bifásico
    Ib = P / (V * pf);
  }
  
  // 1. CRITÉRIO DA CAPACIDADE DE CORRENTE
  const Iz = Ib / (FCT * FCA);
  // Monofásico e Bifásico usam 2 condutores carregados. Trifásico usa 3.
  const numConductors = (systemType === 'three') ? 3 : 2;
  const S_iz = findSectionByCurrent(Iz, method, numConductors, el.selMaterial.value);
  if (S_iz === null) {
    return { error: `Nenhum cabo padrão suporta a corrente corrigida (Iz = ${Iz.toFixed(2)} A) para o método ${method}. Verifique os parâmetros.` };
  }

  // 2. CRITÉRIO DA QUEDA DE TENSÃO
  const material = el.selMaterial.value;
  // Resistividade a 70°C (temp. de operação para isolação PVC)
  const rho = material === 'copper' ? 0.0225 : 0.036; // Ω·mm²/m
  const dV = (vdP / 100) * V;

  let S_vd = 0;
  // Para queda de tensão, monofásico e bifásico (F+F) usam o fator 2 (ida e volta).
  // Trifásico usa sqrt(3).
  if (systemType === 'three') S_vd = (Math.sqrt(3) * rho * L * Ib) / dV;
  else S_vd = (2 * rho * L * Ib) / dV;

  const S_vd_rounded = Number.isFinite(S_vd) ? Math.max(S_vd, 0.5) : null;

  // 3. COMPARAÇÃO E SUGESTÃO FINAL
  const standardSizes = [0.5,0.75,1,1.5,2.5,4,6,10,16,25,35,50,70,95,120,150,185,240,300];
  // Encontra a seção padrão imediatamente superior à calculada pela queda de tensão
  const S_vd_standard = standardSizes.find(s => s >= S_vd_rounded) || standardSizes[standardSizes.length - 1];

  // A seção final deve atender a AMBOS os critérios. Portanto, pegamos a maior das duas.
  const final_S_calculated = Math.max(S_vd_standard, S_iz);

  // 4. APLICAR MÍNIMO NORMATIVO (ILUMINAÇÃO/TOMADA - NBR 5410 item 6.2.6.2.2)
  const circuitType = el.selCircuitType.value;
  const minGauge = circuitType === 'lighting' ? 1.5 : 2.5;
  const final_S = Math.max(final_S_calculated, minGauge);

  // 5. SUGESTÃO DO DISJUNTOR (In)
  const Iz_final = getCableCapacity(final_S, method, numConductors, material) * FCT * FCA;
  const In = findBreaker(Ib, Iz_final, circuitType);

  // Encontra a queda de tensão real com o cabo escolhido
  let final_vd = 0; //
  if (systemType === 'three') {
    final_vd = (Math.sqrt(3) * rho * L * Ib) / final_S;
  } else {
    final_vd = (2 * rho * L * Ib) / final_S;
  }
  const final_vd_percent = (final_vd / V) * 100;

  return {
    I: Number(Ib.toFixed(2)),
    Iz: Number(Iz.toFixed(2)),
    S_vd: S_vd_rounded ? Number(S_vd_rounded.toFixed(2)) : null,
    S_iz: S_iz,
    suggestion: final_S,
    Iz_final: Number(Iz_final.toFixed(2)),
    breaker: In,
    finalVdPercent: Number(final_vd_percent.toFixed(2)),
    material,
    voltage: V,
    length: L,
    vdPercent: vdP,
    system: systemType,
    circuitType: circuitType,
    notes: `Cabo sugerido é o maior valor entre: Queda de Tensão (${S_vd_standard}mm²), Capacidade de Corrente (${S_iz}mm²) e Seção Mínima Normativa (${minGauge}mm²).`
  };
}

/* --- Salva cálculo no Supabase (tabela: calculations) --- */
async function saveCalculation(payload) {
  if (!currentUser) return showMsg('Usuário não autenticado.','error');

  // Monta objeto que será inserido
  const record = {
    user_id: currentUser.id,           // importante para RLS
    tipo_uso: payload.circuitType,
    tipo_circuito: payload.system,
    tensao: payload.voltage,
    potencia: payload.power || null,
    corrente: payload.I,
    comprimento: payload.length,
    material: payload.material, //
    queda_tensao: payload.vdPercent, //
    secao_minima: payload.S_vd,
    cabo_sugerido: String(payload.suggestion),
  };

  try {
    const { error } = await supabase.from('calculations').insert([record]);
    if (error) throw error;
    showMsg('Cálculo salvo com sucesso.', 'success');
    loadHistory();
  } catch (err) {
    console.error('save error', err);
    showMsg('Erro ao salvar cálculo: ' + (err.message || err), 'error');
  }
}

/* --- Carrega histórico do usuário --- */
async function loadHistory() {
  if (!currentUser) return;
  try {
    const { data, error } = await supabase
      .from('calculations')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false })
      .limit(100);
    if (error) throw error;
    renderHistory(data || []);
  } catch (err) {
    console.error('load history err', err);
    showMsg('Erro ao carregar histórico.', 'error');
  }
}

/* --- Remove uma entrada --- */
async function deleteCalculation(id) {
  if (!currentUser) return;
  try {
    const { error } = await supabase.from('calculations').delete().eq('id', id);
    if (error) throw error;
    showMsg('Cálculo removido.', 'success');
    loadHistory();
  } catch (err) {
    console.error('delete err', err);
    showMsg('Erro ao remover cálculo.', 'error');
  }
}

/* --- Renderiza histórico (UI) --- */
function renderHistory(items) {
  const container = el.history;
  container.innerHTML = '';
  if (!items || items.length === 0) {
    el.historyEmpty.classList.remove('hidden');
    return;
  }
  el.historyEmpty.classList.add('hidden');

  items.forEach(it => {
    const div = document.createElement('div');
    div.className = 'p-3 bg-white border rounded flex items-start justify-between gap-3 shadow-sm';
    div.innerHTML = `
      <div class="flex-1">
        <div class="text-sm text-gray-600">${new Date(it.created_at).toLocaleString()}</div>
        <div class="font-bold">${it.cabo_sugerido} mm² — ${it.tipo_uso === 'lighting' ? 'Ilum.' : 'Tomada'} — ${it.tensao} V</div>
        <div class="text-sm text-gray-500">I=${it.corrente} A • L=${it.comprimento} m • vd=${it.queda_tensao}%</div>
      </div>
      <div class="flex flex-col items-end gap-2">
        <button class="btn-delete text-xs text-red-600 px-2 py-1 border rounded" data-id="${it.id}">Excluir</button>
      </div>
    `;
    container.appendChild(div);
  });

  // attach delete handlers
  container.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = btn.getAttribute('data-id');
      if (confirm('Remover este cálculo?')) deleteCalculation(id);
    });
  });
}

/* --- Event listeners UI --- */
el.btnSignup.addEventListener('click', signUp);
el.btnLogin.addEventListener('click', signIn);
el.btnLogout.addEventListener('click', signOut);
el.btnLogout2.addEventListener('click', signOut);
/* calcular -> computa e salva */
el.btnCalc.addEventListener('click', async () => {
  if (!currentUser) return showMsg('Faça login para calcular e salvar.', 'error');
  const result = computeResult();
  if (result.error) return el.resultArea.innerHTML = `<div class="text-red-600">${result.error}</div>`;

  // mostra resultado
  const ib_check = result.I;
  const in_check = result.breaker;
  const iz_check = result.Iz_final;
  const check_ok = ib_check < in_check && in_check < iz_check;

  el.resultArea.innerHTML = `
    <div class="grid grid-cols-2 gap-4">
      <div>
        <div class="text-sm text-gray-600">Corrente de Projeto (Ib)</div>
        <div class="text-2xl font-bold text-teal-600">${result.I} A</div>
      </div>
      <div>
        <div class="text-sm text-gray-600">Corrente Corrigida p/ Cabo (Iz)</div>
        <div class="text-lg font-bold">${result.Iz} A</div>
      </div>
    </div>

    <div class="mt-4 pt-3 border-t">
      ${result.suggestion > Math.max(result.S_iz, result.S_vd) ? 
        `<div id="alerta-secao-minima" class="p-2 mb-3 text-xs text-center rounded-lg bg-amber-100 text-amber-800 border border-amber-200">
          O cabo foi ajustado para a seção mínima de <strong>${result.suggestion.toString().replace('.',',')} mm²</strong> para circuitos de ${result.circuitType === 'lighting' ? 'iluminação' : 'tomadas'}.
         </div>` : ''
      }
      <div id="verificacao-norma" class="p-3 mb-3 rounded-lg text-center ${check_ok ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}">
        <div id="norma-check-text" class="font-bold text-sm">${check_ok ? 'Coordenação OK: Ib < In < Iz' : 'Falha na Coordenação'}</div>
        <div id="norma-check-valores" class="text-xs">
          ${result.I}A &lt; ${result.breaker}A &lt; ${result.Iz_final}A
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4 items-center">
        <div>
          <div class="text-sm text-gray-600">Cabo Sugerido (Seção Comercial)</div>
          <div class="text-3xl font-extrabold text-teal-700">${result.suggestion} mm²</div>
          <div class="text-sm text-gray-500">Capacidade Corrigida (Iz): ${result.Iz_final} A</div>
          <div class="text-sm text-gray-500">Queda de tensão final: ${result.finalVdPercent}%</div>
        </div>
        <div class="text-center bg-gray-100 p-3 rounded-lg">
          <div class="text-sm text-gray-600">Disjuntor Sugerido (In)</div>
          <div class="text-3xl font-extrabold">${result.breaker ? `${result.breaker} A` : 'N/A'}</div>
        </div>
      </div>
    </div>
    <div class="mt-4 text-xs text-gray-500">${result.notes}</div>
  `;

  // junta potência se aplicável
  result.power = Number(el.inputPower.value);

  // salva
  await saveCalculation(result);
});

/* reset */
el.btnReset.addEventListener('click', () => {
  el.inputPower.value = 1000;
  el.inputLength.value = 30;
  el.inputVd.value = 3;
  el.inputPf.value = 0.92;
  el.inputFct.value = "1.00";
  el.inputFca.value = "1.00";
  el.selMethod.value = "B1";
  el.selCircuitType.value = "power";
  el.resultArea.innerHTML = 'Resultados aparecerão aqui após clicar em "Calcular & Salvar".';
});

/* --- DADOS NBR 5410 --- */

// Tabela 36 da NBR 5410: Capacidade de condução de corrente, em ampères
// para métodos de referência A1, A2, B1, B2, C e D. Isolação PVC 70°C.
const NBR5410_TABLE_36_CAPACITY = {
  // Seção (mm²)
  // Colunas: [A1_2, A1_3, A2_2, A2_3, B1_2, B1_3, B2_2, B2_3, C_2, C_3, D_2, D_3]
  // _2 = 2 condutores carregados, _3 = 3 condutores carregados
  // Para alumínio, multiplicar por 0.78
  '0.5':  [9, 8, 8, 7, 11, 9.5, 10, 9, 11.5, 10, null, null],
  '0.75': [11, 10, 10, 9, 13, 12, 12, 11, 14, 12.5, null, null],
  '1':    [13, 12, 12, 11, 15, 14, 14, 13, 16, 14.5, null, null],
  '1.5':  [17, 15, 15, 14, 19.5, 17.5, 18, 16, 21, 18, 20, 17],
  '2.5':  [23, 20, 21, 19, 27, 24, 25, 22, 28, 25, 27, 23],
  '4':    [31, 27, 28, 25, 36, 32, 33, 29, 38, 34, 36, 31],
  '6':    [40, 35, 36, 32, 46, 41, 42, 37, 49, 43, 46, 40],
  '10':   [55, 48, 50, 44, 63, 57, 58, 51, 68, 60, 63, 55],
  '16':   [73, 64, 68, 60, 85, 76, 78, 69, 91, 80, 83, 73],
  '25':   [96, 85, 89, 79, 112, 101, 101, 90, 119, 105, 108, 96],
  '35':   [119, 105, 110, 99, 139, 125, 125, 112, 147, 130, 132, 118],
  '50':   [147, 131, 134, 122, 171, 154, 154, 138, 181, 160, 158, 141],
  '70':   [186, 166, 171, 156, 217, 196, 194, 174, 228, 202, 197, 177],
  '95':   [224, 200, 207, 189, 262, 236, 232, 209, 275, 244, 233, 210],
  '120':  [259, 232, 239, 219, 304, 274, 267, 241, 318, 282, 266, 240],
  '150':  [296, 265, 275, 252, 351, 316, 306, 276, 366, 325, 300, 271],
  '185':  [337, 302, 314, 288, 404, 364, 349, 315, 421, 374, 338, 306],
  '240':  [396, 356, 370, 340, 477, 431, 408, 369, 497, 443, 390, 353],
  '300':  [455, 409, 426, 392, 552, 498, 467, 423, 574, 513, 442, 400],
};

const STANDARD_BREAKERS = [2, 4, 6, 10, 13, 16, 20, 25, 32, 35, 40, 50, 63, 70, 80, 90, 100, 125];

function findBreaker(Ib, Iz, circuitType) {
  // Define um disjuntor mínimo prático baseado no tipo de circuito (inspirado na NBR 5410 6.3.3.1)
  // Iluminação: geralmente 10A. Tomadas (TUG): geralmente 16A ou 20A.
  // Isso evita sugerir disjuntores muito pequenos (ex: 2A) para cargas baixas.
  const minPracticalBreaker = circuitType === 'lighting' ? 10 : 16;
  
  // Condição da norma: Ib <= In <= Iz
  // Encontra o menor disjuntor padrão (In) que seja >= Ib
  let suitableBreaker = STANDARD_BREAKERS.find(In => In >= Ib);

  // Se o disjuntor encontrado for menor que o mínimo prático, usa o mínimo prático
  if (suitableBreaker && suitableBreaker < minPracticalBreaker) {
    suitableBreaker = minPracticalBreaker;
  }

  // Se não encontrou disjuntor (Ib > 125A), retorna nulo
  if (!suitableBreaker) return null;

  // Agora, a verificação final e mais importante: o disjuntor escolhido protege o cabo? (In <= Iz)
  // Se sim, retorna o disjuntor. Se não, o circuito não é seguro com essa combinação.
  if (suitableBreaker <= Iz) {
    return suitableBreaker;
  }
  return null; // Não há disjuntor padrão que atenda às condições
}

const METHOD_TO_COLUMN_INDEX = {
  'A1': 0, 'A2': 2, 'B1': 4, 'B2': 6, 'C': 8, 'D': 10
};

function findSectionByCurrent(Iz, method, numConductors, material) {
  const columnIndexBase = METHOD_TO_COLUMN_INDEX[method];
  if (columnIndexBase === undefined) return null; // Método inválido

  // Ajusta para 2 ou 3 condutores carregados
  const columnIndex = columnIndexBase + (numConductors === 3 ? 1 : 0);

  const aluminumFactor = material === 'aluminum' ? 0.78 : 1.0;

  // Itera sobre as seções padrão para encontrar a primeira que suporta a corrente Iz_min
  for (const sectionStr in NBR5410_TABLE_36_CAPACITY) {
    const section = parseFloat(sectionStr);
    const capacities = NBR5410_TABLE_36_CAPACITY[sectionStr];
    const capacity = capacities[columnIndex];

    if (capacity === null || capacity === undefined) continue;

    const adjustedCapacity = capacity * aluminumFactor;

    if (adjustedCapacity >= Iz) {
      return section; // Encontrou a seção adequada
    }
  }

  return null; // Nenhuma seção padrão suporta a corrente
}

function getCableCapacity(section, method, numConductors, material) {
  const sectionStr = String(section);
  if (!NBR5410_TABLE_36_CAPACITY[sectionStr]) return 0;

  const columnIndexBase = METHOD_TO_COLUMN_INDEX[method];
  if (columnIndexBase === undefined) return 0;

  const columnIndex = columnIndexBase + (numConductors === 3 ? 1 : 0);
  const baseCapacity = NBR5410_TABLE_36_CAPACITY[sectionStr][columnIndex];
  if (baseCapacity === null || baseCapacity === undefined) return 0;

  const aluminumFactor = material === 'aluminum' ? 0.78 : 1.0;
  return baseCapacity * aluminumFactor;
}

/* --- Inicialização: verifica sessão atual --- */
(async function init() {
  try {
    const { data } = await supabase.auth.getUser();
    currentUser = data?.user ?? null;
    setLoggedState(currentUser);
  } catch (err) {
    console.error('auth init err', err);
    setLoggedState(null);
  }
})();
</script>
</body>
</html>
